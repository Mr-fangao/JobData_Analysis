<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <title>聚合图</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' rel='stylesheet' />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    #infoDiv {
      background: white;
      padding: 10px;
    }

    .esri-attribution {
      display: none;
    }

    .esri-view .esri-view-surface--inset-outline:focus::after {
      outline: auto 0px Highlight !important;
      outline: auto 0px -webkit-focus-ring-color !important;
    }
  </style>
</head>

<body>
  <div id='map'></div>
  </div>
  <script>
   mapboxgl.accessToken =
        'pk.eyJ1IjoibXItZmFuZ2FvIiwiYSI6ImNrdWRneHhsODFhNWUycW1heThvZ3Jpc2YifQ.Vn63ovCsqYuuggh33vAiFg';
      var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/navigation-night-v1', // stylesheet location
        center: [107, 39], // starting position [lng, lat]
        zoom: 3.3 // starting zoom
      });
      var navigationControl = new mapboxgl.NavigationControl();
      map.addControl(navigationControl, "top-left");

    map.on('load', function () {
      // Add a new source from our GeoJSON data and set the
      // 'cluster' option to true. GL-JS will add the point_count property to your source data.
      // 添加数据源
      map.addSource("03test", {
        type: "geojson",
        // Point to GeoJSON data. This example visualizes all M1.0+ earthquakes
        // from 12/22/15 to 1/21/16 as logged by USGS' Earthquake hazards program.
        data: "./data/03.json",
        cluster: true,
        clusterMaxZoom: 14, // Max zoom to cluster points on
        clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
      });
      // 添加圆形聚合图层
      map.addLayer({
        id: "clusters",
        type: "circle",
        source: "03test",
        filter: ["has", "point_count"],
        paint: {
          // Use step expressions (https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-step)
          // with three steps to implement three types of circles:
          //   * Blue, 20px circles when point count is less than 100
          //   * Yellow, 30px circles when point count is between 100 and 750
          //   * Pink, 40px circles when point count is greater than or equal to 750
          "circle-color": [
            "step",
            ["get", "point_count"],
            "#51bbd6",
            100,
            "#f1f075",
            750,
            "#f28cb1"
          ],
          "circle-radius": [
            "step",
            ["get", "point_count"],
            20,
            100,
            30,
            750,
            40
          ]
        }
      });
      // 添加数字图层
      map.addLayer({
        id: "cluster-count",
        type: "symbol",
        source: "03test",
        filter: ["has", "point_count"],
        layout: {
          "text-field": "{point_count_abbreviated}",
          "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
          "text-size": 12
        }
      });
      // 添加未聚合图层
      map.addLayer({
        id: "unclustered-point",
        type: "circle",
        source: "03test",
        filter: ["!", ["has", "point_count"]],
        paint: {
          "circle-color": "#11b4da",
          "circle-radius": 4,
          "circle-stroke-width": 1,
          "circle-stroke-color": "#fff"
        }
      });

      // inspect a cluster on click  点击聚合图层地图级别中心点变化
      map.on('click', 'clusters', function (e) {
        var features = map.queryRenderedFeatures(e.point, {
          layers: ['clusters']
        });
        var clusterId = features[0].properties.cluster_id;
        map.getSource('03test').getClusterExpansionZoom(clusterId, function (err, zoom) {
          if (err)
            return;

          map.easeTo({
            center: features[0].geometry.coordinates,
            zoom: zoom
          });
        });
      });
      // 聚合图层鼠标移入样式
      map.on('mouseenter', 'clusters', function () {
        map.getCanvas().style.cursor = 'pointer';
      });
      // 聚合图层鼠标移出鼠标样式
      map.on('mouseleave', 'clusters', function () {
        map.getCanvas().style.cursor = '';
      });
      let popup = new mapboxgl.Popup({
        className: 'my-class'
      });
      // 未聚合图层鼠标点击pop框显示
      map.on('click', 'unclustered-point', function (e) {
        console.log(e);
        let features = e.features[0].properties;
        popup.setLngLat(e.lngLat)
        popup.setHTML("<h1>Hello World!</h1>")
        popup.setMaxWidth("300px")
        popup.addTo(map);
      });
      map.on('mouseenter', 'unclustered-point', function () {
        // 改变鼠标样式
        map.getCanvas().style.cursor = 'pointer';
      });
      // 未聚合图层鼠标移出pop框隐藏
      map.on('mouseleave', 'unclustered-point', function () {
        // 改变鼠标样式
        map.getCanvas().style.cursor = '';
        popup.remove();
      });
    });
  </script>

</body>

</html>